const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mediaLayerUtils-MA8Smwz2.js","assets/utils-V4fw_T9z.js","assets/index-DKOmzAMm.js","assets/index-6Ap435l7.css","assets/originUtils-D69mHv66.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/jsonContext-SE-5k22x.js","assets/saveAPIKeyUtils-CqAN5-r5.js","assets/saveUtils-oCA1ZjYH.js","assets/resourceUtils-CwAv7wd8.js","assets/resourceUtils-Cz4P0EKM.js"])))=>i.map(i=>d[i]);
import{g7 as Fe,bm as Je,au as rt,B as l,E as P,gU as De,gF as q,V as B,D as u,Q as f,cn as lt,ay as Oe,s as N,hS as R,aS as ne,d2 as me,aX as fe,F as at,aZ as Se,cI as ct,hT as Le,hU as ut,cT as ht,c$ as te,hV as pt,cv as Xe,aN as qe,n as dt,cR as Me,cV as mt,cS as ft,cU as yt,hQ as Ke,cW as gt,hW as xt,U as _t,ck as vt,aV as Pt,b3 as wt,dR as $t,hX as Rt,ad as It,aA as bt,aC as Ot,hY as St,az as Tt,aB as Qe,hZ as Et,h_ as Lt,bw as Mt,gP as Re,h$ as Ct,a7 as de,i0 as jt,b1 as Ht,bx as Nt,c7 as At,fu as Vt,ce as Wt,ab as zt,cf as Gt,i1 as Ut,cq as Bt,cu as kt,cs as Ft,ct as Jt,dz as Dt,eJ as ae,d7 as Xt,cE as qt,_ as Kt}from"./index-DKOmzAMm.js";import{u as Ze,i as Ye,c as et,r as Ce,s as Qt}from"./mat3-BNGRf_pC.js";import{e as k,t as Zt}from"./mat3f64-q3fE-ZOt.js";import{o as O,I as X,_ as je}from"./vec2-CurFBDJu.js";import{n as I,r as ce}from"./vec2f64-DA6GkJuH.js";import{p as Yt}from"./imageUtils-D81CeaJ0.js";import{p as en}from"./resourceExtension-D3awQbhZ.js";import{o as tn}from"./BoundsStore-BShGRkMU.js";import{r as He,s as nn,i as Z}from"./normalizeUtilsCommon-BatUY1sD.js";import"./PooledRBush-CdrRkOdh.js";import"./quickselect-D0_cvEX6.js";import"./_commonjsHelpers-DCkdB7M8.js";const v=rt(),F=k(),Pe=k(),Ne=k();function S(e,t,n){return Fe(v,t[0],t[1],1),Je(v,v,Ze(F,n)),v[2]===0?O(e,v[0],v[1]):O(e,v[0]/v[2],v[1]/v[2])}function tt(e,t,n){return Ae(Pe,t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]),Ae(Ne,n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7]),Ye(e,et(Pe,Pe),Ne),e[8]!==0&&(e[0]/=e[8],e[1]/=e[8],e[2]/=e[8],e[3]/=e[8],e[4]/=e[8],e[5]/=e[8],e[6]/=e[8],e[7]/=e[8],e[8]/=e[8]),e}function Ae(e,t,n,s,o,i,r,a,c){Ce(e,t,s,i,n,o,r,1,1,1),Fe(v,a,c,1),et(F,e);const[h,p,d]=Je(v,v,Ze(F,F));return Ce(F,h,0,0,0,p,0,0,0,d),Ye(e,F,e)}let Ie=class extends De{projectOrWarn(e,t){if(e==null)return e;const{geometry:n,pending:s}=q(e,t);return s?null:s||n?n:(B.getLogger(this).warn("geometry could not be projected to the spatial reference",{georeference:this,geometry:e,sourceSpatialReference:e.spatialReference,targetSpatialReference:t}),null)}};Ie=l([P("esri.layers.support.GeoreferenceBase")],Ie);const se=Ie,we=k(),m=I();let Y=class extends at{};l([u({type:Number,json:{write:!0}})],Y.prototype,"x",void 0),l([u({type:Number,json:{write:!0}})],Y.prototype,"y",void 0),Y=l([P("esri.layers.support.ControlPointsGeoreference.ControlPointJSONType")],Y);let ee=class extends De{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};l([u()],ee.prototype,"sourcePoint",void 0),l([u({type:f})],ee.prototype,"mapPoint",void 0),ee=l([P("esri.layers.support.ControlPointsGeoreference.ControlPoint")],ee);let w=class extends lt(se){constructor(t){super(t),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(t,n){const s=Oe.fromJSON(n.spatialReference),o=Zt(...n.coefficients,1);return t.map(i=>(O(m,i.x,i.y),S(m,m,o),{sourcePoint:i,mapPoint:new f({x:m[0],y:m[1],spatialReference:s})}))}writeControlPoints(t,n,s,o){if(this.transform!=null)t!=null&&_(t[0])&&(n.controlPoints=t.map(i=>{const r=i.sourcePoint;return{x:r.x,y:r.y}}),n.spatialReference=t[0].mapPoint.spatialReference.toJSON(),n.coefficients=this.transform.slice(0,8));else{const i=new N("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:o==null?void 0:o.layer,georeference:this});o!=null&&o.messages?o.messages.push(i):B.getLogger(this).error(i.name,i.message)}}get coords(){if(this.controlPoints==null)return null;const t=this._updateTransform(we);if(t==null||!_(this.controlPoints[0]))return null;const n=this.controlPoints[0].mapPoint.spatialReference;return an(t,this.width,this.height,n)}set coords(t){if(this.controlPoints==null||!_(this.controlPoints[0]))return;const n=this.controlPoints[0].mapPoint.spatialReference;if((t=this.projectOrWarn(t,n))==null)return;const{width:s,height:o}=this,{rings:[[i,r,a,c]]}=t,h={sourcePoint:R(0,o),mapPoint:new f({x:i[0],y:i[1],spatialReference:n})},p={sourcePoint:R(0,0),mapPoint:new f({x:r[0],y:r[1],spatialReference:n})},d={sourcePoint:R(s,0),mapPoint:new f({x:a[0],y:a[1],spatialReference:n})},y={sourcePoint:R(s,o),mapPoint:new f({x:c[0],y:c[1],spatialReference:n})};_(h)&&_(p)&&_(d)&&_(y)&&(Ve(we,h,p,d,y),this.controlPoints=this.controlPoints.map(({sourcePoint:x})=>(O(m,x.x,x.y),S(m,m,we),{sourcePoint:x,mapPoint:new f({x:m[0],y:m[1],spatialReference:n})})))}get inverseTransform(){return this.transform==null?null:Qt(k(),this.transform)}get transform(){return this._updateTransform()}toMap(t){if(t==null||this.transform==null||this.controlPoints==null||!_(this.controlPoints[0]))return null;O(m,t.x,t.y);const n=this.controlPoints[0].mapPoint.spatialReference;return S(m,m,this.transform),new f({x:m[0],y:m[1],spatialReference:n})}toSource(t){if(t==null||this.inverseTransform==null||this.controlPoints==null||!_(this.controlPoints[0]))return null;const n=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),(t=q(t,n).geometry)==null?null:(O(m,t.x,t.y),S(m,m,this.inverseTransform),R(m[0],m[1]))}toSourceNormalized(t){const n=this.toSource(t);return n!=null&&(n.x/=this.width,n.y/=this.height),n}_updateTransform(t){const{controlPoints:n,width:s,height:o}=this;if(!(n!=null&&s>0&&o>0))return null;const[i,r,a,c]=n;if(!_(i))return null;const h=i.mapPoint.spatialReference,p=this._projectControlPoint(r,h),d=this._projectControlPoint(a,h),y=this._projectControlPoint(c,h);if(!p.valid||!d.valid||!y.valid||!_(p.controlPoint))return null;t==null&&(t=k());let x=null;return x=_(d.controlPoint)&&_(y.controlPoint)?Ve(t,i,p.controlPoint,d.controlPoint,y.controlPoint):_(d.controlPoint)?on(t,i,p.controlPoint,d.controlPoint):sn(t,i,p.controlPoint),x.every(ye=>ye===0)?null:x}_projectControlPoint(t,n){if(!_(t))return{valid:!0,controlPoint:t};const{sourcePoint:s,mapPoint:o}=t,{geometry:i,pending:r}=q(o,n);return r?{valid:!1,controlPoint:null}:r||i?{valid:!0,controlPoint:{sourcePoint:s,mapPoint:i}}:(B.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:o.spatialReference,targetSpatialReference:n}),{valid:!1,controlPoint:null})}};function _(e){return(e==null?void 0:e.sourcePoint)!=null&&e.mapPoint!=null}l([u({type:[ee],json:{write:{allowNull:!1,isRequired:!0,target:{controlPoints:{type:[Y]},coefficients:{type:[Number]},spatialReference:{type:Oe}}}}})],w.prototype,"controlPoints",void 0),l([ne("controlPoints")],w.prototype,"readControlPoints",null),l([me("controlPoints")],w.prototype,"writeControlPoints",null),l([u({clonable:!1})],w.prototype,"coords",null),l([u({type:Number,nonNullable:!0,json:{write:!0}})],w.prototype,"height",void 0),l([u({readOnly:!0})],w.prototype,"inverseTransform",null),l([u({readOnly:!0})],w.prototype,"transform",null),l([u({type:Number,nonNullable:!0,json:{write:!0}})],w.prototype,"width",void 0),w=l([P("esri.layers.support.ControlPointsGeoreference")],w);const T=I(),E=I(),G=I(),A=I(),L=I(),M=I(),U=I(),V=I(),ue=Math.PI/2;function C(e,t,n){O(e,n.sourcePoint.x,n.sourcePoint.y),O(t,n.mapPoint.x,n.mapPoint.y)}function sn(e,t,n){return C(T,L,t),C(E,M,n),X(G,E,T,ue),X(A,T,E,ue),X(U,M,L,-ue),X(V,L,M,-ue),Te(e,T,E,G,A,L,M,U,V)}function on(e,t,n,s){return C(T,L,t),C(E,M,n),C(G,U,s),je(A,T,E,.5),X(A,G,A,Math.PI),je(V,L,M,.5),X(V,U,V,Math.PI),Te(e,T,E,G,A,L,M,U,V)}function Ve(e,t,n,s,o){return C(T,L,t),C(E,M,n),C(G,U,s),C(A,V,o),Te(e,T,E,G,A,L,M,U,V)}const rn=new Array(8).fill(0),ln=new Array(8).fill(0);function We(e,t,n,s,o){return e[0]=t[0],e[1]=t[1],e[2]=n[0],e[3]=n[1],e[4]=s[0],e[5]=s[1],e[6]=o[0],e[7]=o[1],e}function Te(e,t,n,s,o,i,r,a,c){return tt(e,We(rn,t,n,s,o),We(ln,i,r,a,c))}function an(e,t,n,s){const o=ce(0,n),i=ce(0,0),r=ce(t,0),a=ce(t,n);return S(o,o,e),S(i,i,e),S(r,r,e),S(a,a,e),new fe({rings:[[o,i,r,a,o]],spatialReference:s})}const oe=w,K=I();let j=class extends se{constructor(t){super(t),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type="corners"}get coords(){let{topLeft:t,topRight:n,bottomLeft:s,bottomRight:o}=this;if(t==null||n==null||s==null||o==null)return null;const i=t.spatialReference;return n=this.projectOrWarn(n,i),s=this.projectOrWarn(s,i),o=this.projectOrWarn(o,i),n==null||s==null||o==null?null:new fe({rings:[[[s.x,s.y],[t.x,t.y],[n.x,n.y],[o.x,o.y],[s.x,s.y]]],spatialReference:i})}set coords(t){const{topLeft:n}=this;if(n==null)return;const s=n.spatialReference;if((t=this.projectOrWarn(t,s))==null)return;const{rings:[[o,i,r,a]]}=t;this.bottomLeft=new f({x:o[0],y:o[1],spatialReference:s}),this.topLeft=new f({x:i[0],y:i[1],spatialReference:s}),this.topRight=new f({x:r[0],y:r[1],spatialReference:s}),this.bottomRight=new f({x:a[0],y:a[1],spatialReference:s})}toSourceNormalized(t){const{topLeft:n,topRight:s,bottomRight:o,bottomLeft:i}=this;if(t==null||n==null||s==null||o==null||i==null)return null;const r=n.spatialReference;t=t.normalize();const a=q(t,r).geometry;if(a==null)return null;O(K,a.x,a.y);const c=tt(k(),[n.x,n.y,i.x,i.y,s.x,s.y,o.x,o.y],[0,0,0,1,1,0,1,1]);return S(K,K,c),R(K[0],K[1])}};l([u({clonable:!1})],j.prototype,"coords",null),l([u({type:f})],j.prototype,"bottomLeft",void 0),l([u({type:f})],j.prototype,"bottomRight",void 0),l([u({type:f})],j.prototype,"topLeft",void 0),l([u({type:f})],j.prototype,"topRight",void 0),j=l([P("esri.layers.support.CornersGeoreference")],j);const cn=j;let J=class extends se{constructor(t){super(t),this.extent=null,this.rotation=0,this.type="extent-and-rotation"}get coords(){if(this.extent==null)return null;const{xmin:t,ymin:n,xmax:s,ymax:o,spatialReference:i}=this.extent;let r;if(this.rotation){const{x:a,y:c}=this.extent.center,h=$e(a,c,this.rotation);r=[h(t,n),h(t,o),h(s,o),h(s,n)],r.push(r[0])}else r=[[t,n],[t,o],[s,o],[s,n],[t,n]];return new fe({rings:[r],spatialReference:i})}set coords(t){if(t==null||this.extent==null)return;const n=this.extent.spatialReference;if(t=this.projectOrWarn(t,n),(t==null?void 0:t.extent)==null)return;const{rings:[[s,o,i]],extent:{center:{x:r,y:a}}}=t,c=ct(Math.PI/2-Math.atan2(o[1]-s[1],o[0]-s[0])),h=$e(r,a,-c),[p,d]=h(s[0],s[1]),[y,x]=h(i[0],i[1]);this.extent=new Se({xmin:p,ymin:d,xmax:y,ymax:x,spatialReference:n}),this.rotation=c}toSourceNormalized(t){const{extent:n,rotation:s}=this;if(t==null||n==null)return null;const{xmin:o,ymin:i,xmax:r,ymax:a,center:c,spatialReference:h}=n;t=t.normalize();const p=q(t,h).geometry;if(p==null)return null;let d=p.x,y=p.y;return s&&([d,y]=$e(c.x,c.y,-s)(d,y)),R(Le(d,o,r,0,1),Le(y,a,i,0,1))}};function $e(e,t,n){const s=ut(n),o=Math.cos(s),i=Math.sin(s);return(r,a)=>[o*(r-e)+i*(a-t)+e,o*(a-t)-i*(r-e)+t]}l([u({clonable:!1})],J.prototype,"coords",null),l([u({type:Se})],J.prototype,"extent",void 0),l([u({type:Number})],J.prototype,"rotation",void 0),J=l([P("esri.layers.support.ExtentAndRotationGeoreference")],J);const un=J;function hn(e){return(e==null?void 0:e.type)==="media"}function nt(e,t){const n=ht(t);return hn(e)&&!!e.portalItem&&n!=null&&n>te.PORTAL_ITEM}function pn(e,t,n){var h;if(!e||e.type==="control-points")return e;const{coords:s}=e;if(((h=s==null?void 0:s.rings[0])==null?void 0:h.length)!==5)return null;const[o,i,r,a]=s.rings[0],{spatialReference:c}=s;return new oe({controlPoints:[{mapPoint:new f({x:o[0],y:o[1],spatialReference:c}),sourcePoint:R(0,n)},{mapPoint:new f({x:i[0],y:i[1],spatialReference:c}),sourcePoint:R(0,0)},{mapPoint:new f({x:r[0],y:r[1],spatialReference:c}),sourcePoint:R(t,0)},{mapPoint:new f({x:a[0],y:a[1],spatialReference:c}),sourcePoint:R(t,n)}],width:t,height:n})}const dn={key:"type",base:se,typeMap:{"control-points":oe,corners:cn,"extent-and-rotation":un}},mn={key:"type",base:se,typeMap:{"control-points":oe}};let z=class extends pt(Xe(qe)){constructor(e){super(e),this.georeference=null,this.opacity=1}readGeoreference(e){return oe.fromJSON(e)}writeGeoreference(e,t,n,s){var r;const o=(r=s==null?void 0:s.resources)==null?void 0:r.pendingOperations,i=()=>{var c;const a=pn(this.georeference,this.contentWidth,this.contentHeight);if(a){if(e.type!=="control-points"&&B.getLogger(this).warn(`only georeference of type 'control-points' may be persisted. The georeference of type '${e.type}' has been automatically converted.`),((c=a.controlPoints)==null?void 0:c.length)!==4&&(s==null?void 0:s.messages))return void s.messages.push(new N("property:unsupported","only 'control-points' georeference with 4 control points may be persisted."));t[n]=a.write({},s)}};if(e.type!=="control-points"&&!this.loaded&&o)return t[n]={},void o.push(this.load().then(i));i()}get contentWidth(){return 0}get contentHeight(){return 0}toSource(e){const{georeference:t,contentWidth:n,contentHeight:s}=this;if(e==null||t==null||n===0||s===0)return null;const o=t.toSourceNormalized(e);return o==null?null:(o.x*=n,o.y*=s,o)}};l([u({types:dn,json:{write:!0,types:mn}})],z.prototype,"georeference",void 0),l([ne("georeference")],z.prototype,"readGeoreference",null),l([me("georeference")],z.prototype,"writeGeoreference",null),l([u({json:{read:!1,write:!1}})],z.prototype,"opacity",void 0),z=l([P("esri.layers.support.MediaElementBase")],z);const Ee=z;let $=class extends Ee{constructor(t){super(t),this.animationOptions=null,this.content=null,this.image=null,this.type="image",this.image=null}load(){const t=this.image;if(typeof t=="string"){const n=Yt(t).then(s=>{this._set("content",s)});this.addResolvingPromise(n)}else if(t instanceof HTMLImageElement){const n=t.decode().then(()=>{this._set("content",t)});this.addResolvingPromise(n)}else t?this._set("content",t):this.addResolvingPromise(Promise.reject(new N("image-element:invalid-image-type","Invalid image type",{image:t})));return Promise.resolve(this)}get contentWidth(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalWidth:this.content.width}get contentHeight(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalHeight:this.content.height}readImage(t,n,s){return dt(n.url,s)}writeImage(t,n,s,o){if(t==null)return;const i=o==null?void 0:o.portalItem,r=o==null?void 0:o.resources;if(!i||!r)return void(typeof t=="string"&&(n[s]=Me(t,o)));const a=fn(t)?t:null;if(a){if(mt(a)==null)return void(n[s]=a);const c=Me(a,{...o,verifyItemRelativeUrls:o!=null&&o.verifyItemRelativeUrls?{writtenUrls:o.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},ft.NO);if(i&&c&&!yt(c))return r.toKeep.push({resource:i.resourceFromPath(c),compress:!1}),void(n[s]=c)}n[s]="<pending>",r.pendingOperations.push(yn(t).then(c=>{const h=xn(c,i);n[s]=h.itemRelativeUrl,r.toAdd.push({resource:h,content:{type:"blob",blob:c},compress:!1,finish:p=>{this.image=p.url}})}))}write(t,n){const s=super.write(t,n);return"mediaType"in s&&!s.url&&delete s.mediaType,s}};l([u()],$.prototype,"animationOptions",void 0),l([u({readOnly:!0})],$.prototype,"content",void 0),l([u({readOnly:!0})],$.prototype,"contentWidth",null),l([u({readOnly:!0})],$.prototype,"contentHeight",null),l([u({json:{name:"url",type:String,write:{overridePolicy:(e,t,n)=>({enabled:!nt(n==null?void 0:n.layer,n==null?void 0:n.origin)})}}})],$.prototype,"image",void 0),l([ne("image",["url"])],$.prototype,"readImage",null),l([me("image")],$.prototype,"writeImage",null),l([u({readOnly:!0,json:{read:!1,write:{target:"mediaType",ignoreOrigin:!0}}})],$.prototype,"type",void 0),$=l([P("esri.layers.support.ImageElement")],$);const st=$;function fn(e){return typeof e=="string"&&!Ke(e)&&!gt(e)}async function yn(e){return typeof e=="string"?Ke(e)?xt(e):(await _t(e,{responseType:"blob"})).data:new Promise(t=>gn(e).toBlob(t))}function gn(e){if(e instanceof HTMLCanvasElement)return e;const t=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,s=document.createElement("canvas"),o=s.getContext("2d");return s.width=t,s.height=n,e instanceof HTMLImageElement?o.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&o.putImageData(e,0,0),s}function xn(e,t){const n=vt(),s=`${Pt("media",n)}.${en({type:"blob",blob:e})}`;return t.resourceFromPath(s)}function _n(e){return vn(e,!0)}function vn(e,t){if(e==null)return null;const n=e.spatialReference,s=$t(n),o=Rt(e)?e.toJSON():e;if(!s)return o;const i=It(n)?102100:4326,r=He[i].maxX,a=He[i].minX;if(bt(o))return ze(o,r,a);if(Ot(o))return o.points=o.points.map(c=>ze(c,r,a)),o;if(St(o))return Pn(o,s);if(Tt(o)||Qe(o)){const c=Et($n,o),h={xmin:c[0],ymin:c[1],xmax:c[2],ymax:c[3]},p=Z(h.xmin,a)*(2*r),d=p===0?o:nn(o,p);return h.xmin+=p,h.xmax+=p,h.xmax>r?Ue(d,r,t):h.xmin<a?Ue(d,a,t):d}return o}function Pn(e,t){if(!t)return e;const n=wn(e,t).map(s=>s.extent);return n.length<2?n[0]||e:n.length>2?(e.xmin=t.valid[0],e.xmax=t.valid[1],e):{rings:n.map(s=>[[s.xmin,s.ymin],[s.xmin,s.ymax],[s.xmax,s.ymax],[s.xmax,s.ymin],[s.xmin,s.ymin]])}}function ze(e,t,n){if(Array.isArray(e)){const s=e[0];if(s>t){const o=Z(s,t);e[0]=s+o*(-2*t)}else if(s<n){const o=Z(s,n);e[0]=s+o*(-2*n)}}else{const s=e.x;if(s>t){const o=Z(s,t);e.x+=o*(-2*t)}else if(s<n){const o=Z(s,n);e.x+=o*(-2*n)}}return e}function wn(e,t){const n=[],{ymin:s,ymax:o,xmin:i,xmax:r}=e,a=e.xmax-e.xmin,[c,h]=t.valid,{x:p,frameId:d}=Ge(e.xmin,t),{x:y,frameId:x}=Ge(e.xmax,t),ye=p===y&&a>0;if(a>2*h){const ge={xmin:i<r?p:y,ymin:s,xmax:h,ymax:o},xe={xmin:c,ymin:s,xmax:i<r?y:p,ymax:o},_e={xmin:0,ymin:s,xmax:h,ymax:o},ve={xmin:c,ymin:s,xmax:0,ymax:o},ie=[],re=[];he(ge,_e)&&ie.push(d),he(ge,ve)&&re.push(d),he(xe,_e)&&ie.push(x),he(xe,ve)&&re.push(x);for(let le=d+1;le<x;le++)ie.push(le),re.push(le);n.push(new W(ge,[d]),new W(xe,[x]),new W(_e,ie),new W(ve,re))}else p>y||ye?n.push(new W({xmin:p,ymin:s,xmax:h,ymax:o},[d]),new W({xmin:c,ymin:s,xmax:y,ymax:o},[x])):n.push(new W({xmin:p,ymin:s,xmax:y,ymax:o},[d]));return n}function Ge(e,t){const[n,s]=t.valid,o=2*s;let i,r=0;return e>s?(i=Math.ceil(Math.abs(e-s)/o),e-=i*o,r=i):e<n&&(i=Math.ceil(Math.abs(e-n)/o),e+=i*o,r=-i),{x:e,frameId:r}}function he(e,t){const{xmin:n,ymin:s,xmax:o,ymax:i}=t;return pe(e,n,s)&&pe(e,n,i)&&pe(e,o,i)&&pe(e,o,s)}function pe(e,t,n){return t>=e.xmin&&t<=e.xmax&&n>=e.ymin&&n<=e.ymax}function Ue(e,t,n=!0){const s=!Qe(e);if(s&&Lt(e),n)return new Rn().cut(e,t);const o=s?e.rings:e.paths,i=s?4:2,r=o.length,a=-2*t;for(let c=0;c<r;c++){const h=o[c];if(h&&h.length>=i){const p=[];for(const d of h)p.push([d[0]+a,d[1]]);o.push(p)}}return s?e.rings=o:e.paths=o,e}class W{constructor(t,n){this.extent=t,this.frameIds=n}}const $n=wt();class Rn{constructor(){this._linesIn=[],this._linesOut=[]}cut(t,n){let s;if(this._xCut=n,t.rings)this._closed=!0,s=t.rings,this._minPts=4;else{if(!t.paths)return null;this._closed=!1,s=t.paths,this._minPts=2}for(const i of s){if(!i||i.length<this._minPts)continue;let r=!0;for(const a of i)r?(this.moveTo(a),r=!1):this.lineTo(a);this._closed&&this.close()}this._pushLineIn(),this._pushLineOut(),s=[];for(const i of this._linesIn)i&&i.length>=this._minPts&&s.push(i);const o=-2*this._xCut;for(const i of this._linesOut)if(i&&i.length>=this._minPts){for(const r of i)r[0]+=o;s.push(i)}return this._closed?t.rings=s:t.paths=s,t}moveTo(t){this._pushLineIn(),this._pushLineOut(),this._prevSide=this._side(t[0]),this._moveTo(t[0],t[1],this._prevSide),this._prevPt=t,this._firstPt=t}lineTo(t){const n=this._side(t[0]);if(n*this._prevSide==-1){const s=this._intersect(this._prevPt,t);this._lineTo(this._xCut,s,0),this._prevSide=0,this._lineTo(t[0],t[1],n)}else this._lineTo(t[0],t[1],n);this._prevSide=n,this._prevPt=t}close(){const t=this._firstPt,n=this._prevPt;t[0]===n[0]&&t[1]===n[1]||this.lineTo(t),this._checkClosingPt(this._lineIn),this._checkClosingPt(this._lineOut)}_moveTo(t,n,s){this._closed?(this._lineIn.push([s<=0?t:this._xCut,n]),this._lineOut.push([s>=0?t:this._xCut,n])):(s<=0&&this._lineIn.push([t,n]),s>=0&&this._lineOut.push([t,n]))}_lineTo(t,n,s){this._closed?(Be(this._lineIn,s<=0?t:this._xCut,n),Be(this._lineOut,s>=0?t:this._xCut,n)):s<0?(this._prevSide===0&&this._pushLineOut(),this._lineIn.push([t,n])):s>0?(this._prevSide===0&&this._pushLineIn(),this._lineOut.push([t,n])):this._prevSide<0?(this._lineIn.push([t,n]),this._lineOut.push([t,n])):this._prevSide>0&&(this._lineOut.push([t,n]),this._lineIn.push([t,n]))}_checkClosingPt(t){const n=t.length;n>3&&t[0][0]===this._xCut&&t[n-2][0]===this._xCut&&t[1][0]===this._xCut&&(t[0][1]=t[n-2][1],t.pop())}_side(t){return t<this._xCut?-1:t>this._xCut?1:0}_intersect(t,n){const s=(this._xCut-t[0])/(n[0]-t[0]);return t[1]+s*(n[1]-t[1])}_pushLineIn(){this._lineIn&&this._lineIn.length>=this._minPts&&this._linesIn.push(this._lineIn),this._lineIn=[]}_pushLineOut(){this._lineOut&&this._lineOut.length>=this._minPts&&this._linesOut.push(this._lineOut),this._lineOut=[]}}function Be(e,t,n){const s=e.length;s>1&&e[s-1][0]===t&&e[s-2][0]===t?e[s-1][1]=n:e.push([t,n])}let b=class extends Mt{constructor(e){super(e)}get bounds(){const e=this.coords;return(e==null?void 0:e.extent)==null?null:Re(e.extent)}get coords(){var t;const e=(t=this.element.georeference)==null?void 0:t.coords;return q(e,this.spatialReference).geometry}get normalizedCoords(){return fe.fromJSON(_n(this.coords))}get normalizedBounds(){const e=this.normalizedCoords!=null?this.normalizedCoords.extent:null;return e!=null?Re(e):null}};l([u()],b.prototype,"spatialReference",void 0),l([u()],b.prototype,"element",void 0),l([u()],b.prototype,"bounds",null),l([u()],b.prototype,"coords",null),l([u()],b.prototype,"normalizedCoords",null),l([u()],b.prototype,"normalizedBounds",null),b=l([P("esri.layers.support.MediaElementView")],b);let H=class extends Ee{constructor(e){super(e),this.autoplay=!0,this.content=null,this.type="video"}load(){const e=this.video;if(typeof e=="string"){const t=document.createElement("video");t.src=e,t.crossOrigin="anonymous",t.autoplay=!0,t.muted=!0,t.loop=!0,t.playsInline=!0,this.addResolvingPromise(this._loadVideo(t).then(()=>{this._set("content",t)}))}else e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set("content",e)})):this.addResolvingPromise(Promise.reject(new N("video-element:invalid-video-type","Invalid video type",{video:e})));return Promise.resolve(this)}get contentWidth(){var e;return((e=this.content)==null?void 0:e.videoWidth)??0}get contentHeight(){var e;return((e=this.content)==null?void 0:e.videoHeight)??0}set video(e){this.loadStatus==="not-loaded"?this._set("video",e):B.getLogger(this).error("#video","video cannot be changed after the element is loaded.")}_loadVideo(e){return new Promise((t,n)=>{var o;const s=Ct(e,"canplay",()=>{this.removeHandles("canplay"),this.autoplay?e.play().then(t,n):t()});this.addHandles(s,"canplay"),e.crossOrigin!=="anonymous"&&(e.crossOrigin="anonymous",(o=e.src)!=null&&o.includes("blob:")||(e.src=e.src))})}};l([u()],H.prototype,"autoplay",void 0),l([u({readOnly:!0})],H.prototype,"content",void 0),l([u({readOnly:!0})],H.prototype,"contentWidth",null),l([u({readOnly:!0})],H.prototype,"contentHeight",null),l([u()],H.prototype,"video",null),H=l([P("esri.layers.support.VideoElement")],H);const ot=H,In={key:"type",defaultKeyValue:"image",base:Ee,typeMap:{image:st,video:ot}},ke=de.ofType(In);let D=class extends qe.LoadableMixin(jt(Ht.EventedAccessor)){constructor(e){super(e),this._index=new tn,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=t=>{for(const s of t.removed){const o=this._elementViewsMap.get(s);this._elementViewsMap.delete(s),this._index.delete(o),this.removeHandles(o),o.destroy(),this.notifyChange("fullExtent")}const{spatialReference:n}=this;for(const s of t.added){if(this._elementViewsMap.get(s))continue;const o=new b({spatialReference:n,element:s});this._elementViewsMap.set(s,o);const i=Nt(()=>o.coords,()=>this._updateIndexForElement(o,!1));this._updateIndexForElement(o,!0),this.addHandles(i,o)}this._elementsIndexes.clear(),this.elements.forEach((s,o)=>this._elementsIndexes.set(s,o)),this.emit("refresh")},this.elements=new ke}async load(e){if(At(e),!this.spatialReference){const t=this.elements.find(n=>{var s;return((s=n.georeference)==null?void 0:s.coords)!=null});this._set("spatialReference",t?t.georeference.coords.spatialReference:Oe.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.addHandles(this.elements.on("change",this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(e){this._set("elements",Vt(e,this._get("elements"),ke))}get fullExtent(){if(this.loadStatus==="not-loaded")return null;const e=this._index.fullBounds;return e==null?null:new Se({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){this.loadStatus==="not-loaded"?this._set("spatialReference",e):B.getLogger(this).error("#spatialReference","spatialReference cannot be changed after the source is loaded.")}async queryElements(e,t){await this.load(),await Wt(e.spatialReference,this.spatialReference,null,t);const n=zt(e.spatialReference,this.spatialReference)?e:Gt(e,this.spatialReference);if(!n)return[];const s=n.normalize(),o=[];for(const i of s)this._index.forEachInBounds(Re(i),({normalizedCoords:r,element:a})=>{r!=null&&Ut(i,r)&&o.push(a)});return o.sort((i,r)=>this._elementsIndexes.get(i)-this._elementsIndexes.get(r)),o}hasElement(e){return this.elements.includes(e)}_updateIndexForElement(e,t){const n=e.normalizedBounds,s=this._index.has(e),o=n!=null;this._index.delete(e),o&&this._index.set(e,n),this.notifyChange("fullExtent"),t||(s!==o?this.emit("refresh"):this.emit("change",{element:e.element}))}};l([u()],D.prototype,"elements",null),l([u({readOnly:!0})],D.prototype,"fullExtent",null),l([u()],D.prototype,"spatialReference",null),D=l([P("esri.layers.support.LocalMediaElementSource")],D);const Q=D;function be(e){return typeof e=="object"&&e!=null&&"type"in e}function it(e){return be(e)&&e.type==="image"}let g=class extends Bt(kt(Ft(Jt(Xe(qt))))){constructor(e){super(e),this.effectiveSource=null,this.georeference=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this._debouncedSaveOperations=Dt(async(t,n,s)=>{const{save:o,saveAs:i}=await Kt(()=>import("./mediaLayerUtils-MA8Smwz2.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]));switch(t){case ae.SAVE:return o(this,n);case ae.SAVE_AS:return i(this,s,n)}}),this.source=new Q}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){await this.loadFromPortal({supportedTypes:["Media Layer"]},e);let t=this.source;if(!t)throw new N("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer.");const n=this._getSourceOverride(t,this.georeference);n&&(this.setAtOrigin("source",n,"web-map"),this.setAtOrigin("source",n,"web-scene"),t=n);const s=be(t)?new Q({elements:new de([t])}):t;this._set("effectiveSource",s),this.spatialReference&&(s.spatialReference=this.spatialReference),await s.load(e),this.spatialReference=s.spatialReference}destroy(){var e,t;(e=this.effectiveSource)==null||e.destroy(),this.effectiveSource!==this.source&&((t=this.source)==null||t.destroy())}readGeoreference(e,t){return e&&"itemId"in t&&t.itemId?e:void 0}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("source",e):B.getLogger(this).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)?new Q({elements:new de(e)}):e instanceof de?new Q({elements:e}):e:null}readSource(e,t,n){if("itemId"in t&&t.itemId)return;const s=this._createSource(t);return s==null||s.read(t,n),s}writeSource(e,t,n,s){if(e&&e instanceof Q){const o=e.elements.length;if(o!==1)return void((s==null?void 0:s.messages)&&s.messages.push(new N("media-layer:unsupported-source",`local media element source can only be persisted if it contains exactly one ImageElement, but it has ${o}.`)));e=e.elements.at(0)}it(e)?e.write(t,s):s!=null&&s.messages&&(e?s.messages.push(new N("media-layer:unsupported-source","only media elements of type 'ImageElement' can be persisted")):s.messages.push(new N("media-layer:unsupported-source","the media layer is missing a source")))}async save(e){return this._debouncedSaveOperations(ae.SAVE,e)}async saveAs(e,t){return this._debouncedSaveOperations(ae.SAVE_AS,t,e)}_createSource(e){if("mediaType"in e)switch(e.mediaType){case"image":return new st;case"video":return new ot}return null}_getSourceOverride(e,t){if(be(e)&&this.originIdOf("source")===te.PORTAL_ITEM&&t&&(this.originIdOf("georeference")===te.WEB_MAP||this.originIdOf("georeference")===te.WEB_SCENE)){const n=e.toJSON(),s=this._createSource(n);return s.read({...n},{origin:"portal-item"}),s.read({georeference:t},{origin:"web-map"}),s.read({georeference:t},{origin:"web-scene"}),s}return null}};l([u({readOnly:!0})],g.prototype,"effectiveSource",void 0),l([u({readOnly:!0,json:{read:!1,write:!1,origins:{"web-document":{read:!0}}}})],g.prototype,"georeference",void 0),l([ne("web-document","georeference")],g.prototype,"readGeoreference",null),l([u({type:String})],g.prototype,"copyright",void 0),l([u({readOnly:!0})],g.prototype,"fullExtent",null),l([u({type:["MediaLayer"]})],g.prototype,"operationalLayerType",void 0),l([u({type:["show","hide"]})],g.prototype,"listMode",void 0),l([u({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1,target:{url:{type:String},mediaType:{type:["image"]},georeference:{type:oe}},overridePolicy(e,t,n){return{enabled:!0,allowNull:!1,ignoreOrigin:nt(this,n==null?void 0:n.origin)&&it(e)&&!!e.georeference&&e.originIdOf("georeference")>te.PORTAL_ITEM}}}}})],g.prototype,"source",null),l([Xt("source")],g.prototype,"castSource",null),l([ne("source",["url"])],g.prototype,"readSource",null),l([me("source")],g.prototype,"writeSource",null),l([u()],g.prototype,"spatialReference",void 0),l([u({readOnly:!0})],g.prototype,"type",void 0),g=l([P("esri.layers.MediaLayer")],g);const kn=g;export{kn as default};
