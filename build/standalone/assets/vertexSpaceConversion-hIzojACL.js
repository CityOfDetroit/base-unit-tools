import{bp as H,bk as L,dZ as Y,au as G,d_ as Z,d$ as _,e0 as M,bq as T,e1 as B,bv as h,dx as D,e2 as I,V as K,c2 as Q,cJ as W}from"./index-DPsNinHg.js";import{j as X}from"./mat3-rZ-mTNvn.js";import{e as nn}from"./mat3f64-q3fE-ZOt.js";import{o as tn,e as E}from"./mat4f64-CSKppSlJ.js";import{a as x}from"./spatialReferenceEllipsoidUtils-DezkNiKH.js";import{u as v}from"./computeTranslationToOriginAndRotation-Bv7U4Gwl.js";import{m as rn}from"./meshVertexSpaceUtils-WW_N9la0.js";import{i as F,e as S,f as z}from"./vec3-ByRlkoJb.js";import{logProjectionError as $,transformNormal as k,transformTangent as q,projectFromPCPF as on,projectNormalFromPCPF as en,projectTangentFromPCPF as an,projectToPCPF as ln,projectNormalToPCPF as sn,projectTangentToPCPF as cn}from"./projection-Cwlhe49F.js";function O(n,t,o,e){if(H(n.spatialReference,o)){w[0]=n.x,w[1]=n.y;const a=n.z;return w[2]=a??e??0,L(w,n.spatialReference,0,t,o,0,1)}const r=Y(n,o);return!!r&&(t[0]=r==null?void 0:r.x,t[1]=r==null?void 0:r.y,t[2]=(r==null?void 0:r.z)??e??0,!0)}const w=G(),p=()=>K.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion");function Nn(n,t,{vertexSpace:o,spatialReference:e}){if(o.type==="georeferenced"){const u=n;if(!O(t,u,e))return!1;const{origin:c}=o;return Q(n,u,c),!0}const r=x(e),a=n;if(!O(t,a,r))return!1;const{origin:l}=o,s=U;if(!v(e,l,s,r))return!1;const i=h(U,s);return i!=null&&(W(n,a,i),!0)}function On(n,t,o){const{vertexSpace:e,transform:r,vertexAttributes:a}=n,l=y(n.spatialReference,o,g.SOURCE|g.TARGET);if(rn(e,t)&&(!r||Z(r.localMatrix,tn))&&_(l,1)){const{position:s,normal:i,tangent:u}=a,c=o==null?void 0:o.allowBufferReuse;return{position:c?s:s.slice(),normal:c?i:i==null?void 0:i.slice(),tangent:c?u:u==null?void 0:u.slice()}}switch(n.vertexSpace.type){case"local":return t.type==="local"?mn(n,n.vertexSpace,t.origin,o):fn(n,n.vertexSpace,t.origin,o);case"georeferenced":return t.type==="local"?pn(n,n.vertexSpace,t.origin,o):un(n,n.vertexSpace,t.origin,o)}}function un({vertexAttributes:n,transform:t,spatialReference:o},{origin:e},r,a){const{position:l,normal:s,tangent:i}=t?P(n,t.localMatrix):n,u=new Float64Array(l.length);let c=l;if(e&&(c=F(u,c,e)),r){const A=M(V,r);c=F(u,c,A)}y(o,a,g.NONE);const m=a==null?void 0:a.allowBufferReuse;return{position:c!==n.position||m?c:c.slice(),normal:s!==n.normal||m?s:s==null?void 0:s.slice(),tangent:i!==n.tangent||m?i:i==null?void 0:i.slice()}}function fn({spatialReference:n,vertexAttributes:t,transform:o},{origin:e},r,a){const l=x(n);if(!v(n,e,f,l))return $(p(),n,l),null;o&&T(f,f,o.localMatrix),J(f,n,a,g.SOURCE);const s=new Float64Array(t.position.length),i=$n(t.position,f,n,s);if(!i)return null;const u=xn(i,s,t.normal,f,n);if(t.normal&&!u)return null;const c=An(i,s,t.tangent,f,n);if(t.tangent&&!c)return null;if(r){const m=M(V,r);F(i,i,m)}return{position:i,normal:u,tangent:c}}function pn({vertexAttributes:n,spatialReference:t,transform:o},{origin:e},r,a){const l=x(t);if(!v(t,r,f,l))return $(p(),t,l),null;const s=1/y(t,a,g.TARGET);B(f,f,[s,s,s]);const i=h(R,f),{position:u,normal:c,tangent:m}=gn(n,e,o),A=new Float64Array(u.length),C=Rn(u,t,i,A);if(!C)return null;const j=X(wn,i),d=vn(c,u,A,t,j,c!==n.normal?c:void 0);if(!d&&c)return null;const N=Fn(m,u,A,t,j,m!==n.tangent?m:void 0);return!N&&m?null:{position:C,normal:d,tangent:N}}function gn(n,t,o){if(!t)return n;if(!o){const{position:r,normal:a,tangent:l}=n;return{position:F(new Float64Array(r.length),r,t),tangent:l,normal:a}}const e=P(n,o.localMatrix);return F(e.position,e.position,t),e}function mn({vertexAttributes:n,spatialReference:t,transform:o},{origin:e},r,a){const l=x(t);if(!v(t,e,f,l))return $(p(),t,l),null;if(o&&T(f,f,o.localMatrix),!v(t,r,R,l))return $(p(),l,t),null;h(R,R);const s=T(f,R,f);return J(s,t,a,g.SOURCE|g.TARGET),P(n,s)}function P(n,t){const o=new Float64Array(n.position.length);S(o,n.position,t);const e=n.normal?new Float32Array(n.normal.length):null,r=n.tangent?new Float32Array(n.tangent.length):null;return e&&n.normal&&k(n.normal,e,t),r&&n.tangent&&q(n.tangent,r,t),{position:o,normal:e,tangent:r}}function $n(n,t,o,e){S(e,n,t);const r=new Float64Array(n.length);return on(e,r,o)?r:($(p(),x(o),o),null)}function xn(n,t,o,e,r){if(o==null)return null;const a=new Float32Array(o.length);return k(o,a,e),en(a,n,t,r,a)?a:($(p(),x(r),r),null)}function An(n,t,o,e,r){if(o==null)return null;const a=new Float32Array(o.length);return q(o,a,e),an(a,n,t,r,a)?a:($(p(),x(r),r),null)}function J(n,t,o,e){const r=y(t,o,e);r!==1&&B(n,n,[r,r,r])}function y(n,t,o){const e=!!(o&g.SOURCE),r=!!(o&g.TARGET),a=t==null?void 0:t.sourceUnit,l=t==null?void 0:t.targetUnit;if(!a&&!l)return 1;let s=b(a,n);!e&&a&&s!==1&&(p().warn("source unit conversion not supported"),s=1);let i=1/b(l,n);return!r&&l&&i!==1&&(p().warn("target unit conversion not supported"),i=1),s*i}function Rn(n,t,o,e){const r=ln(n,t,e);if(!r)return $(p(),t,x(t)),null;const a=new Float64Array(r.length);return S(a,r,o),a}function vn(n,t,o,e,r,a){if(n==null)return null;const l=a??new Float32Array(n.length);return sn(n,t,o,e,l)?(z(l,l,r),l):($(p(),e,x(e)),null)}function Fn(n,t,o,e,r,a){if(n==null)return null;const l=a??new Float32Array(n.length);return cn(n,t,o,e,l)?(z(l,l,r,4),l):($(p(),e,x(e)),null)}function b(n,t){if(n==null)return 1;const o=D(t);return 1/I(o,"meters",n)}const f=E(),R=E(),wn=nn(),V=G(),U=E();var g;(function(n){n[n.NONE=0]="NONE",n[n.SOURCE=1]="SOURCE",n[n.TARGET=2]="TARGET"})(g||(g={}));export{On as M,Nn as N,b as X,O as c};
